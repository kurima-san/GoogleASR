<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>
			Web Speech API
		</title>
		<link rel="stylesheet" href=
		"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<link href=
		"//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
		rel="stylesheet">
		<link href="style.css" rel="stylesheet">
		<link href="style.css" rel="stylesheet">
	</head>
	<body>
		<!--
		<textarea id="recognitionText" cols="100" rows="10">
		</textarea>
		<br>
		<textarea id="status" cols="100" rows="1">
		</textarea>
		<br>
		<input type="button" onClick="vr_function();" value="音認開始">
-->
		<!--
		<div id="google_translate_element"></div> 
		<script type="text/javascript"> 
			function googleTranslateElementInit() { 
				new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element'); 
			} 
		</script> 
		<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> 
		-->
		
		<div class="contents">
			<div class="container">
				<div class="setting">
					<div class="row">
						<div class="col-sm-4">
							<select id="selectLang" class="form-control pull-left">
								<option value="ja-JP">日本語</option>
								<option value="en-US">English</option>
								<option value="es-MX">Español (México)</option>
							</select>
						</div>
					</div>
				</div>
				<div class="recognition">
					<div class="row">
						<div class="col-sm-8">
							<!--
							<textarea id="recognitionText" type="text" class=
							"form-control pull-left" placeholder=
							"ここに音声認識結果が表示されます" readonly></textarea>
							-->
							<fieldset>
							<legend>認識結果1.5</legend>
							<p><div id="result type"></div></p>
							<p><div id="confidence"></div></p>
							<p><div id="recognitionText"></div></p>
							</fieldset>
							
						</div>
						<div class="col-sm-4">
							<button id="recognitionStartButton" class="btn btn-default" type=
							"button" value="recognitionStart" onclick=
							"asr_start_function();">話してみる</button>
							<button id=
							"recognitionStopButton" class="btn btn-default" type="button"
							value="recognitionStop" onclick=
							"asr_stop_function();">話すの中断 </button>
							
							
							<div id="google_translate_element"></div> 
							<script type="text/javascript"> 
								function googleTranslateElementInit() { 
									new google.translate.TranslateElement({pageLanguage: 'ja'}, 'google_translate_element');
								} 
							</script> 
							<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script> 
							
						</div>
					</div>
				</div>
				<div class="message">
					<div class="row">
						<div class="col-sm-12">
							<div id="messageArea"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<script>
			var flag_speech = 0;
			var flag_start = false;
			recognitionFormControl(false);
			var recognition = new webkitSpeechRecognition();
			
			var rawText = "";
			var confidenceLevel = -1;
			
			var isTranslating = false;
			
			function asr_start_function() {
					flag_start = true;
					window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
					//var recognition = new webkitSpeechRecognition();
					recognition = new webkitSpeechRecognition();
					var num = document.getElementById('selectLang').selectedIndex;
					var selectLang = document.getElementById('selectLang').options[num].value;
					//recognition.lang = 'ja';
					//console.log(selectLang);
					recognition.lang = selectLang;
					recognition.interimResults = true;
					recognition.continuous = true;

					
					recognition.onsoundstart = function() {
						document.getElementById('messageArea').innerHTML = "認識中";
						console.log("startrecog:");
					};
					recognition.onnomatch = function() {
						document.getElementById('messageArea').innerHTML = "もう一度試してください";
					};
					recognition.onerror = function() {
						document.getElementById('messageArea').innerHTML = "エラー";
						if(flag_speech == 0 && flag_start)
							asr_start_function();
					};
					recognition.onsoundend = function() {
						document.getElementById('messageArea').innerHTML = "停止中";
						if(flag_start)asr_start_function();
					};

					recognition.onresult = function(event) {
						var results = event.results;
						for (var i = event.resultIndex; i < results.length; i++) {
								if (results[i].isFinal)
								{
									rawText = results[i][0].transcript;
									confidenceLevel = results[i][0].confidence;
									console.log( "result:"+rawText + "\nconfidence:" + confidenceLevel);
									document.getElementById('result type').innerHTML = "[final]";
									document.getElementById('confidence').innerHTML = confidence;
									document.getElementById('recognitionText').innerHTML = results[i][0].transcript;
									document.getElementById('recognitionText').classList.remove('isNotFinal');
									if(flag_start)asr_start_function();
									
								}
								else
								{
									rawText = results[i][0].transcript;
									confidenceLevel = -1;
									
									console.log( "interimresult:"+rawText);
									document.getElementById('result type').innerHTML = "[interim]";
									document.getElementById('confidence').innerHTML = "-1";
									document.getElementById('recognitionText').innerHTML = results[i][0].transcript;
									document.getElementById('recognitionText').classList.add('isNotFinal');
									flag_speech = 1;
								}
						}
						
						//if(!flag_start)recognition.stop();
					}
					
					flag_speech = 0;
					document.getElementById('messageArea').innerHTML = "start";
					recognition.start();
					recognitionFormControl(true);
			}
			
			function asr_stop_function() {
				recognition.stop();
				document.getElementById('messageArea').innerHTML = "stop";
				flag_start = false;
				recognitionFormControl(false);
			}
			
			function recognitionFormControl(start){
				if(start){
					document.getElementById('recognitionStartButton').setAttribute('disabled','true');
					document.getElementById('recognitionStopButton').setAttribute('disabled','false');
					document.getElementById('recognitionStopButton').removeAttribute('disabled');
				}else{
					document.getElementById('recognitionStopButton').setAttribute('disabled','true');
					document.getElementById('recognitionStartButton').setAttribute('disabled','false');
					document.getElementById('recognitionStartButton').removeAttribute('disabled');
				}
			}
			
	           	
			document.getElementById("recognitionText").addEventListener("DOMSubtreeModified", translationResultCallback, false);
			//document.getElementById("recognitionText").addEventListener("change", translationCallback, false);
			function translationResultCallback() {
				// This function needs to be called when Google translates this web page.
				var currentHTML = document.getElementById("recognitionText").innerHTML;
				var currentValue = document.getElementById("recognitionText").innerText;
				if(currentValue == ""){
					//
				} else {
					if(currentValue.indexOf(rawText) != -1){
						console.log("Translating : " + currentValue);
					} else {
						console.log("Translated : " + currentValue);
					}
				}
				//console.log("Translated : " + currentValue);
			}
			
			document.getElementById("google_translate_element").addEventListener("DOMSubtreeModified", translationStartCallback, false);
			function translationStartCallback() {
				
				var selectItems = document.getElementById(':0.targetLanguage').getElementsByClassName('goog-te-combo');
				if(selectItems.length > 0){
					var num = selectItems[0].selectedIndex;
					console.log(num + ":"+selectItems[0]);
					if(num > 0){
						var selectLang = selectItems[0].options[num].value;
						console.log("Start translation : "+selectLang);
					} else {
						console.log("not start translation");
					}
				}
			}
		 </script>
        
        
        
        
	</body>
</html>
