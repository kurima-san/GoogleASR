<!DOCTYPE html>
<html>
 
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web Speech API</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">

    <link href="style.css" rel="stylesheet">
    
</head>
 
<body>
<!--
    <textarea id="recognitionText" cols="100" rows="10">
    </textarea>
    <br>
    <textarea id="status" cols="100" rows="1">
    </textarea>
    <br>
    <input type="button" onClick="vr_function();" value="音認開始">
-->
  <div class="contents">
    <div class="container">

	<div class="recognition">
	  <div class="row">
	    <div class="col-sm-8">
	      <textarea id="recognitionText" type="text" class="form-control pull-left" placeholder="ここに音声認識結果が表示されます"></textarea>
	    </div>
	    <div class="col-sm-4">
	      <button id="recognitionStartButton" class="btn btn-default" type="button" value="recognitionStart"  onClick="asr_start_function();">話してみる <i class="fa fa-microphone fa-fw"></i>
	      </button>
	      <button id="recognitionStopButton" class="btn btn-default" type="button" value="recognitionStop"  onClick="asr_stop_function();">話すの中断 <i class="fa fa-microphone-slash fa-fw"></i>
	      </button>
	    </div>
	  </div>
	</div>

	<div class="message">
	  <div class="row">
	    <div class="col-sm-12">
	      <div id="messageArea"></div>
	    </div>
	  </div>
	</div>

  </div>
</div>

</body>
 
 
    <script>
        var flag_speech = 0;
        var flag_start = false;
        recognitionFormControl(false);
        
        function asr_start_function() {
            flag_start = true;
            window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
            var recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja';
            recognition.interimResults = true;
            recognition.continuous = true;
 
            
            recognition.onsoundstart = function() {
                document.getElementById('messageArea').innerHTML = "認識中";
            };
            recognition.onnomatch = function() {
                document.getElementById('messageArea').innerHTML = "もう一度試してください";
            };
            recognition.onerror = function() {
                document.getElementById('messageArea').innerHTML = "エラー";
                if(flag_speech == 0 && flag_start)
                  asr_start_function();
            };
            recognition.onsoundend = function() {
                document.getElementById('messageArea').innerHTML = "停止中";
                if(flag_start)asr_start_function();
            };
 
            recognition.onresult = function(event) {
                var results = event.results;
                for (var i = event.resultIndex; i < results.length; i++) {
                    if (results[i].isFinal)
                    {
                        var confidence = results[i][0].confidence;
                        console.log( "result: "+results[i][0].transcript + "\nconfidence: " + confidence);
                        document.getElementById('recognitionText').innerHTML = "[final] " + results[i][0].transcript+"(confidence:"+confidence+")";
                        document.getElementById('recognitionText').classList.remove('isNotFinal');
                        if(flag_start)asr_start_function();
                        
                    }
                    else
                    {
                        console.log( "interimresult: "+results[i][0].transcript);
                        document.getElementById('recognitionText').innerHTML = "[interim] " + results[i][0].transcript;
                        document.getElementById('recognitionText').classList.add('isNotFinal');
                        flag_speech = 1;
                    }
                }
            }
            
            flag_speech = 0;
            document.getElementById('messageArea').innerHTML = "start";
            recognition.start();
            recognitionFormControl(false);
        }
        
        function asr_stop_function() {
          flag_start = false;
          recognitionFormControl(true);
        }
        
        function recognitionFormControl(start){
          if(start){
            document.getElementById('recognitionStartButton').setAttribute('disabled','true');
            document.getElementById('recognitionStopButton').setAttribute('disabled','false');
            document.getElementById('recognitionStopButton').removeAttribute('disabled');
          }else{
            document.getElementById('recognitionStopButton').setAttribute('disabled','true');
            document.getElementById('recognitionStartButton').setAttribute('disabled','false');
            document.getElementById('recognitionStartButton').removeAttribute('disabled');
          }
        }
        
    </script> 
 
</html>